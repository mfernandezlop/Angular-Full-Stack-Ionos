# Please do not edit this file.
# Build steps can be customized in the Angular-Full-Stack-Ionos-build.yaml.
# More information under https://docs.ionos.space/docs/github-actions-customization/
# version: 2022-07-21

name: "Deploy Now: Orchestration"
run-name: "Deploy Now: Build Angular-Full-Stack-Ionos Â· ${{ github.event.head_commit.message || format('Triggered by {0}', github.triggering_actor) }}"

on:
  - push
  - workflow_dispatch

jobs:
  retrieve-project:
    name: check readiness
    runs-on: ubuntu-latest
    outputs:
      deployment-enabled: ${{ fromJson(steps.project.outputs.info).deployment-enabled }}
      branch-id: ${{ fromJson(steps.project.outputs.info).branch-id }}
    steps:
      - name: Fetch project data
        uses: ionos-deploy-now/project-action@v1
        id: project
        with:
          api-key: ${{ secrets.IONOS_API_KEY }}
          service-host: api-eu.ionos.space
          project-id: 4bc74cac-7f5d-4d21-a829-0bffae752718
          action: retrieve-info


  build:
    name: build
    needs: retrieve-project
    if: ${{ needs.retrieve-project.outputs.deployment-enabled == 'true' }}
    uses: ./.github/workflows/Angular-Full-Stack-Ionos-build.yaml
    with:
      site-url: https://IONOS_DEPLOY_NOW_SITE_URL
      branch-id: ${{ needs.retrieve-project.outputs.branch-id }}
    secrets: inherit

  deploy:
    name: trigger deployment
    needs:
      - retrieve-project
      - build
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch deployment(s)
        uses: ionos-deploy-now/project-action@v1
        with:
          api-key: ${{ secrets.IONOS_API_KEY }}
          service-host: api-eu.ionos.space
          project-id: 4bc74cac-7f5d-4d21-a829-0bffae752718
          branch-id: ${{ needs.retrieve-project.outputs.branch-id }}
          action: dispatch-deployments

  runOnserver:
     name: trigger server
     needs:
       - deploy
     runs-on: ubuntu-latest
     steps:
      - name:  run server
        uses: actions/checkout@v3
        with:
          api-key: ${{ secrets.IONOS_API_KEY }}
          service-host: api-eu.ionos.space
          submodules: 'recursive'

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 16.x
          cache: npm
      - name: Build Node assets
        env:
          CI: true
          SITE_URL: https://IONOS_DEPLOY_NOW_SITE_URL
        run: |
          npm ci
          npm run predev
          npm run dev
